extends ../../layout/defaut.pug
include ../../mixins/search.pug
include ../../mixins/pagination.pug

block main
  if(role.permissions.includes("taikhoan_view"))
    .container-fluid.py-4
      //- 1. HEADER
      .d-flex.justify-content-between.align-items-center.mb-4
        div
          h1.h3.text-primary.fw-bold Quản Lý Nhân Sự
          p.text-muted.mb-0 Danh sách tài khoản và phân quyền hệ thống
        if(role.permissions.includes("taikhoan_add"))
          a.btn.btn-primary.shadow-sm(href=`/${PrefixAdmin}/account/create`)
            i.fas.fa-user-plus.me-2
            | Tạo Tài Khoản Mới

      //- 2. BỘ LỌC (FILTER)
      .card.shadow-sm.mb-4.border-0
        .card-body.p-4
          form(action="" method="GET")
            .row.g-3
              .col-md-6
                +search(keyword)
              
              //- Filter Role (Động)
              .col-md-3
                .form-floating
                  select.form-select(name="role" onchange="this.form.submit()")
                    option(value="" selected=(!roleFilter)) -- Tất cả vai trò --
                    each item in roles
                      option(value=item.id selected=(roleFilter === item.id)) #{item.title}
                  label Lọc theo vai trò

              .col-md-3
                .form-floating
                  select.form-select(name="status" onchange="this.form.submit()")
                    option(value="" selected=(!status)) -- Tất cả trạng thái --
                    option(value="active" selected=(status==="active")) Đang hoạt động
                    option(value="inactive" selected=(status==="inactive")) Đã khóa
                  label Trạng thái

      //- 3. DANH SÁCH USER
      if taikhoan.length > 0
        .row.g-4
          each user in taikhoan
            .col-md-6.col-xl-4
              .card.user-card.h-100.border-0.shadow-sm
                .card-body.p-4
                  .d-flex.align-items-start.mb-3
                    .position-relative.me-3
                      if user.avatar
                        img.avatar-img.rounded-circle(src=user.avatar alt=user.fullName style="width: 60px; height: 60px; object-fit: cover;")
                      else
                        .avatar-placeholder.rounded-circle.bg-light.text-primary.fw-bold.d-flex.align-items-center.justify-content-center(style="width: 60px; height: 60px;")
                          | #{user.fullName.charAt(0).toUpperCase()}
                      
                      span.status-indicator.border.border-white.rounded-circle(
                        class=user.status === 'active' ? 'bg-success' : 'bg-danger'
                        style="width: 15px; height: 15px; position: absolute; bottom: 0; right: 0;"
                      )

                    .flex-grow-1
                      h5.fw-bold.mb-1.text-dark.text-truncate(style="max-width: 200px;") #{user.fullName}
                      //- HIỂN THỊ TÊN QUYỀN Ở ĐÂY
                      if user.roleTitle
                        span.badge.bg-info.rounded-pill.px-3 #{user.roleTitle}
                      else
                        span.badge.bg-secondary.rounded-pill.px-3 Chưa có quyền

                  hr.text-muted.my-3

                  .info-list.d-flex.flex-column.gap-2
                    .d-flex.align-items-center.text-muted
                      i.fas.fa-envelope.me-3(style="width: 20px")
                      span.text-truncate #{user.email}
                    
                    .d-flex.align-items-center.text-muted
                      i.fas.fa-phone.me-3(style="width: 20px")
                      span #{user.phone || '---'}
                    
                    if user.accountFullname
                      .d-flex.align-items-center.text-muted
                        i.fas.fa-user-tag.me-3(style="width: 20px")
                        small Tạo bởi: #{user.accountFullname}

                .card-footer.bg-transparent.border-0.pb-4.pt-0
                  .d-flex.justify-content-between.gap-2
                    if(role.permissions.includes("taikhoan_edit"))
                      a.btn.btn-light.flex-grow-1(href=`/${PrefixAdmin}/account/edit/${user._id}`)
                        i.fas.fa-pen.me-1
                        | Sửa
                    
                    //- Nút thay đổi trạng thái và xóa (Logic giữ nguyên)
                    if user.status === 'active'
                      button.btn.btn-outline-warning(onclick=`changeStatus('${user._id}', 'inactive')`)
                        i.fas.fa-lock
                    else
                      button.btn.btn-outline-success(onclick=`changeStatus('${user._id}', 'active')`)
                        i.fas.fa-unlock
                    
                    if(role.permissions.includes("taikhoan_delete"))
                      button.btn.btn-outline-danger(onclick=`deleteItem('${user._id}')`)
                        i.fas.fa-trash

        .mt-4.d-flex.justify-content-center
          +pagination(pagination)
      
      else
        .text-center.py-5
          h5.text-muted Không tìm thấy tài khoản nào phù hợp.

    //- Form ẩn xử lý logic
    form#form-change-status(action="" method="POST" data-path=`/${PrefixAdmin}/account/change-status`)
    form#form-delete-item(action="" method="POST" data-path=`/${PrefixAdmin}/account/delete`)