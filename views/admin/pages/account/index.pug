extends ../../layout/defaut.pug 
include ../../mixins/search.pug
include ../../mixins/pagination.pug  
block main
    //- -------------------------------------------
    //- [KHU VỰC GIẢ LẬP DỮ LIỆU]
    //- -------------------------------------------
    -
        const keyword = "";
        const roleFilter = "";
        const statusFilter = "";

        // Thêm màu sắc cho Avatar và Role

    //- CSS Tùy chỉnh
    style.
        .user-card { transition: all 0.3s; border: 1px solid #f0f0f0; }
        .user-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.08)!important; border-color: #0d6efd; }
        
        .avatar-box { width: 70px; height: 70px; font-size: 28px; position: relative; }
        
        /* Chấm trạng thái (Online/Offline) */
        .status-dot {
            width: 15px; height: 15px; border-radius: 50%; border: 3px solid #fff;
            position: absolute; bottom: 0; right: 0;
        }
        .status-active { background-color: #198754; }
        .status-inactive { background-color: #dc3545; }

    .container-fluid.mt-4
        //- 1. HEADER
        .d-flex.justify-content-between.align-items-center.mb-4
            div
                h1.text-primary.fw-bold Quản Lý Nhân Sự
                p.text-muted.mb-0 Danh sách tài khoản và phân quyền hệ thống
            
            button.btn.btn-primary.shadow-sm(onclick="window.location.href='/admin/accounts/create'")
                i.fas.fa-user-plus.me-2
                | Tạo Tài Khoản

        //- 2. BỘ LỌC
        .card.shadow-sm.mb-4.border-0
            .card-body
                form.row.g-3(action="", method="GET")
                    .col-md-6
                       +search(keyword)
                    .col-md-3
                        label.form-label.fw-bold Vai trò:
                        select.form-select(name="role", id="selectTaikhoan")
                            option(value="" selected=(!role)) -- Tất cả --
                            option(value="admin" selected=(role==="admin")) Super Admin
                            option(value="editor" selected=(role==="editor")) Editor
                            option(value="staff" selected=(role==="staff")) Staff
                    
                    .col-md-3
                        label.form-label.fw-bold Trạng thái:
                        select.form-select(name="status", id="selectTrangthaitaikhoan")
                            option(value="" selected=(!status)) -- Tất cả --
                            option(value="active"  selected=(status==="active")) Hoạt động
                            option(value="inactive" selected=(status==="inactive")) Đã khóa    

        //- 3. DANH SÁCH USER (CARD GRID)
        if taikhoan.length > 0
            .row.g-4
                each user in taikhoan
                    .col-md-6.col-xl-4
                        .card.user-card.h-100.shadow-sm
                            .card-body.p-4
                                //- Phần thông tin chính
                                .d-flex.align-items-center.mb-4
                                    //- Avatar giả lập
                                    .avatar-box.rounded-circle.d-flex.align-items-center.justify-content-center.text-white.fw-bold.me-3(#{user.avatar})
                                        | #{user.fullName.charAt(0)}
                                        //- Chấm trạng thái
                                        .status-dot(class=user.status === 'active' ? 'status-active' : 'status-inactive')
                                    
                                    div
                                        h5.fw-bold.mb-1.text-dark #{user.fullName}
                                        span.badge.rounded-pill(class=user.roleColor) #{user.role}
                                
                                //- Thông tin chi tiết
                                .d-flex.flex-column.gap-2.mb-4
                                    .d-flex.align-items-center.text-muted
                                        i.fas.fa-briefcase.me-3.text-center(style="width: 20px")
                                        span #{user.title}
                                    .d-flex.align-items-center.text-muted
                                        i.fas.fa-envelope.me-3.text-center(style="width: 20px")
                                        span #{user.email}
                                    .d-flex.align-items-center.text-muted
                                        i.fas.fa-phone.me-3.text-center(style="width: 20px")
                                        span #{user.phone}
                                    .d-flex.align-items-center.text-muted
                                        i.far.fa-clock.me-3.text-center(style="width: 20px")
                                        small Online: #{user.lastLogin}

                            //- Footer Hành động
                            .card-footer.bg-white.border-top-0.pb-3.pt-0
                                .d-flex.justify-content-between.gap-2
                                    a.btn.btn-light.flex-grow-1(href=`/admin/accounts/edit/${user.id}`)
                                        i.fas.fa-cog.me-1
                                        | Cấu hình
                                    
                                    if user.status === 'active'
                                        button.btn.btn-outline-warning(onclick=`toggleStatus(${user.id}, 'inactive')`, title="Khóa tài khoản")
                                            i.fas.fa-lock khóa 
                                    else
                                        button.btn.btn-outline-success(onclick=`toggleStatus(${user.id}, 'active')`, title="Mở khóa")
                                            i.fas.fa-unlock mở khóa
                                    
                                    button.btn.btn-outline-danger(onclick=`deleteAccount(${user.id})`, title="Xóa")
                                        i.fas.fa-trash xóa

        else
            .text-center.py-5
                p.text-muted Không tìm thấy tài khoản nào.

    //- Form ẩn để xử lý Logic
    form#action-form(method="POST", action="")

    //- SCRIPT XỬ LÝ
    script.
        const actionForm = document.getElementById('action-form');

        // Hàm Đổi trạng thái (Khóa/Mở)
        function toggleStatus(id, newStatus) {
            const msg = newStatus === 'inactive' ? 'Bạn muốn KHÓA tài khoản này?' : 'Bạn muốn KÍCH HOẠT lại tài khoản này?';
            if(confirm(msg)) {
                // actionForm.action = `/admin/accounts/change-status/${newStatus}/${id}?_method=PATCH`;
                // actionForm.submit();
                alert(`Đã gửi lệnh đổi trạng thái ID ${id} sang ${newStatus}`);
            }
        }

        // Hàm Xóa tài khoản
        function deleteAccount(id) {
            if(confirm('CẢNH BÁO: Hành động này sẽ xóa vĩnh viễn tài khoản và không thể khôi phục. Bạn chắc chắn chứ?')) {
                // actionForm.action = `/admin/accounts/delete/${id}?_method=DELETE`;
                // actionForm.submit();
                alert(`Đã xóa tài khoản ID ${id}`);
            }
        }
    .mt-4.d-flex.justify-content-center
            +pagination(pagination) 