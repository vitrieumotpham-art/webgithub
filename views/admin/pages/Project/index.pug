extends ../../layout/defaut.pug 
include ../../mixins/search.pug 
include ../../mixins/pagination.pug 
include ../../mixins/sort.pug
include ../../mixins/moment.pug 

block main
  if(role.permissions.includes("duan_view"))
    .container-fluid.mt-4
      .d-flex.justify-content-between.align-items-center.mb-4
        div
          h1.text-primary.fw-bold Quản Lý Dự Án
          p.text-muted.mb-0 Danh sách các công trình và hồ sơ thiết kế

      .card.shadow-sm.mb-4.border-0
        .card-body
          //- Filter Form
          form#filter-form(action="", method="GET")
            .row.g-3.mb-3
              .col-md-8
                +search(keyword)
              .col-md-4.text-end
                if(role.permissions.includes("duan_add"))
                  a.btn.btn-primary.shadow-sm(href=`/${PefixAdmin}/project/create`)
                    i.fas.fa-plus-circle.me-2
                    | Thêm Dự Án Mới
            
            .row.g-3
              .col-md-2
                label.form-label.fw-bold Đặc điểm:
                select.form-select(name="is_noibat", id="noibat")
                  option(value="" selected=(!is_noibat)) -- Tất cả --
                  option(value="true" selected=(is_noibat == "true")) Nổi bật
                  option(value="false" selected=(is_noibat == "false")) Thường
              
              .col-md-2
                label.form-label.fw-bold Trạng thái:
                select.form-select(name="trang_thai", id="statusFilter")
                  option(value="" selected=(!trang_thai)) -- Tất cả --
                  option(value="DangThietKe" selected=(trang_thai == "DangThietKe")) Đang Thiết Kế
                  option(value="DangThiCong" selected=(trang_thai == "DangThiCong")) Đang Thi Công
                  option(value="HoanThien" selected=(trang_thai == "HoanThien")) Hoàn Thiện

              .col-md-3
                label.form-label.fw-bold Loại hình:
                select.form-select(name="loai_hinh", id="loaihinh")
                  option(value="" selected=(!loai_hinh)) -- Tất cả --
                  option(value="VanPhong" selected=(loai_hinh == "VanPhong")) Văn phòng
                  option(value="BietThu" selected=(loai_hinh == "BietThu")) Biệt thự
                  option(value="NoiThat" selected=(loai_hinh == "NoiThat")) Nội thất
                  option(value="NhaPho" selected=(loai_hinh == "NhaPho")) Nhà phố

      .card.shadow-sm.mb-4.border-0
        .card-header.bg-white.py-3
          h6.m-0.fw-bold.text-primary 
            i.fas.fa-sort-amount-down.me-2
            | Sắp xếp dự án
        .card-body
          .row
            .col-md-4
              +sort()

      //- Chức năng thay đổi nhiều
      if duan.length > 0
        .card.shadow-sm.mb-4.border-0
          .card-body.bg-light.rounded
            .d-flex.align-items-center
              .form-check.me-4
                input.form-check-input#checkboxAll(type="checkbox") 
                label.form-check-label.fw-bold(for="checkboxAll") Chọn tất cả
              
              form(
                action=`/${PefixAdmin}/project/change-multi?_method=PATCH`
                method="POST"
                form-change-multi
                class="d-flex align-items-center"
              )
                .form-group.mb-0
                  select(name="type" class="form-select")
                    option(disabled selected) -- Chọn hành động --
                    option(value="true") Đặt Nổi bật 
                    option(value="false") Bỏ Nổi bật 
                    option(value="delete-all") Xóa tất cả
                
                //- Input ẩn để chứa danh sách ID gửi lên server
                input(type="text" name="ids" value="" class="form-control d-none")
                //- Input ẩn để server biết quay lại trang hiện tại sau khi xử lý
                input(type="hidden" name="returnUrl" value=url)
                
                button(type="submit" class="btn btn-primary ms-3") Áp dụng

        .row.g-4
          each item in duan
            .col-12.col-md-6.col-lg-4.col-xl-3
              .card.h-100.shadow-sm.border-0.project-card
                .position-relative
                  //- Checkbox cho từng item
                  .form-check.position-absolute.top-0.start-0.m-2.z-2
                    input.form-check-input.item-checkbox(type="checkbox", value=item._id)
                  
                  a(href=`/${PefixAdmin}/project/detail/${item._id}`)
                    if item.hinh_anh && item.hinh_anh.length > 0
                      img.card-img-top(src=item.hinh_anh[0], alt=item.ten_du_an, style="height: 200px; object-fit: cover;")
                    else
                      img.card-img-top(src="/img/no-image.png", alt="No Image", style="height: 200px; object-fit: cover;")
                  
                  //- Nút thay đổi trạng thái nổi bật đơn lẻ
                  .position-absolute.top-0.end-0.m-2
                    if item.is_noibat
                      button.badge.bg-danger.border-0(
                        data-hoatdong="true" 
                        data-idhoatdong=item._id
                        button-change-hoatdongduan
                        data-return-url=url
                      ) Hot
                    else
                      button.badge.bg-dark.bg-opacity-50.border-0(
                        data-hoatdong="false" 
                        data-idhoatdong=item._id
                        button-change-hoatdongduan
                        data-return-url=url
                      ) Thường

                .card-body
                  h5.card-title.fw-bold.text-truncate.mb-3
                    a.text-decoration-none.text-dark(href=`/${PefixAdmin}/project/detail/${item._id}`) #{item.ten_du_an}
                  
                  .row.g-2.small.text-muted
                    .col-12
                      i.fas.fa-map-marker-alt.me-2.text-danger
                      | #{item.dia_diem}
                    .col-6
                      i.fas.fa-ruler-combined.me-2.text-success
                      | #{item.dien_tich} m²
                    .col-6
                      i.far.fa-calendar-alt.me-2.text-primary
                      | #{item.nam_thuc_hien}

                  //- Thông tin người tạo/cập nhật
                  .mt-3.pt-2.border-top.small
                    .d-flex.align-items-start.mb-2
                      i.fas.fa-user-plus.mt-1.me-2.text-info
                      div
                        span.d-block.fw-bold.text-dark #{item.accountFullname || 'Hệ thống'}
                        if item.createdAt
                          span.text-muted(style="font-size: 0.7rem;") 
                            +formatDateTime(item.createdAt)

                    if item.accountUpdateFullname
                      .d-flex.align-items-start.mt-2.border-top.pt-2
                        i.fas.fa-user-edit.mt-1.me-2.text-warning
                        div
                          span.d-block.fw-bold.text-dark #{item.accountUpdateFullname}
                          if item.lastUpdatedAt
                            span.text-muted(style="font-size: 0.7rem;") 
                              +formatDateTime(item.lastUpdatedAt)

                .card-footer.bg-white.border-top-0.d-flex.justify-content-between.pb-3
                  if(role.permissions.includes("duan_edit"))
                    a.btn.btn-outline-primary.btn-sm.flex-grow-1.me-2(href=`/${PefixAdmin}/project/edit/${item._id}`)
                      i.fas.fa-edit.me-1
                      | Sửa
                  if(role.permissions.includes("duan_delete"))
                    button.btn.btn-outline-danger.btn-sm(data-id=item._id, button-delete)
                      i.fas.fa-trash-alt

        .mt-4.d-flex.justify-content-center
          +pagination(pagination) 
                
      else
        .text-center.py-5
          .py-5.bg-light.rounded-3
            i.fas.fa-folder-open.fa-3x.text-muted.mb-3
            p.text-muted.fs-5 Không tìm thấy dự án nào phù hợp.

    //- ====== CÁC FORM ẨN ĐỂ XỬ LÝ LOGIC (BẮT BUỘC) ======
    
    //- Form đổi trạng thái Nổi bật (PATCH)
    form#form-change-hoatdongduan(
      action="" 
      method="POST" 
      data-path=`/${PefixAdmin}/project/change-hoatdongduan`
    )
      input(type="hidden", name="returnUrl", value="")
      //- method-override sẽ đọc dòng này để hiểu là PATCH
      input(type="hidden", name="_method", value="PATCH")
      
    //- Form xóa (DELETE)
    form#form-delete-item(
      action=""
      method="POST" 
      data-path=`/${PefixAdmin}/project/delete`
    )
      input(type="hidden", name="_method", value="DELETE")