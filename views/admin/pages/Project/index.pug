extends ../../layout/defaut.pug 
include ../../mixins/search.pug  
include ../../mixins/pagination.pug  
block main
    .container-fluid.mt-4
        //- 1. TIÊU ĐỀ
        .d-flex.justify-content-between.align-items-center.mb-4
            div
                h1.text-primary.fw-bold Quản Lý Dự Án
                p.text-muted.mb-0 Danh sách các công trình và hồ sơ thiết kế

        //- 2. BỘ LỌC VÀ TÌM KIẾM
        .card.shadow-sm.mb-4.border-0
            .card-body
                form(action="", method="GET")
                    //- Hàng 1: Tìm kiếm và Nút thêm mới
                    .row.g-3.mb-3
                        .col-md-8
                             +search(keyword)
                        .col-md-4.text-end
                             a.btn.btn-primary.shadow-sm(href="/admin/duan/create")
                                i.fas.fa-plus-circle.me-2
                                | Thêm Dự Án Mới

                    //- Hàng 2: Các Select Filter (Tự động submit khi thay đổi)
                    .row.g-3
                        //- Lọc Đặc điểm
                        .col-md-2
                            label.form-label.fw-bold Đặc điểm:
                            select.form-select(name="is_noibat",id="noibat")
                                option(value="" selected=(!is_noibat)) -- Tất cả --
                                option(value="true" selected=(is_noibat == "true")) Nổi bật
                                option(value="false" selected=(is_noibat == "false")) Thường
                        
                        //- Lọc Trạng thái
                        .col-md-2
                            label.form-label.fw-bold Trạng thái:
                            select.form-select(name="trang_thai", id="statusFilter")
                                option(value="" selected=(!trang_thai)) -- Tất cả --
                                option(value="DangThietKe" selected=(trang_thai == "DangThietKe")) Đang Thiết Kế
                                option(value="DangThiCong" selected=(trang_thai == "DangThiCong")) Đang Thi Công
                                option(value="HoanThien" selected=(trang_thai == "HoanThien")) Hoàn Thiện

                        //- Lọc Loại hình
                        .col-md-3
                            label.form-label.fw-bold Loại hình:
                            select.form-select(name="loai_hinh", id="loaihinh")
                                option(value="" selected=(!loai_hinh)) -- Tất cả --
                                option(value="VanPhong" selected=(loai_hinh == "VanPhong")) Văn phòng
                                option(value="BietThu" selected=(loai_hinh == "BietThu")) Biệt thự
                                option(value="NoiThat" selected=(loai_hinh == "NoiThat")) Nội thất
                                option(value="NhaPho" selected=(loai_hinh == "NhaPho")) Nhà phố

                        //- Lọc Số tầng
                        .col-md-2
                            label.form-label.fw-bold Số tầng:
                            select.form-select(name="so_tang", id="sotang")
                                option(value="" selected=(!so_tang)) -- Tất cả --
                                option(value="1" selected=(so_tang == "1")) 1
                                option(value="2" selected=(so_tang == "2")) 2
                                option(value="3" selected=(so_tang == "3")) 3
                                option(value="4" selected=(so_tang == "4")) 4

                        //- Lọc Năm thực hiện
                        .col-md-3
                            label.form-label.fw-bold Năm thực hiện:
                            select.form-select(name="nam_thuc_hien", id="namthuchien")
                                option(value="" selected=(!nam_thuc_hien)) -- Tất cả --
                                option(value="2022" selected=(nam_thuc_hien == "2022")) 2022
                                option(value="2023" selected=(nam_thuc_hien == "2023")) 2023
                                option(value="2024" selected=(nam_thuc_hien == "2024")) 2024
                                option(value="2025" selected=(nam_thuc_hien == "2025")) 2025

        //- 3. DANH SÁCH DỰ ÁN (GIAO DIỆN GRID CARD)
        if duan.length > 0
            .row.g-4
                each item, index in duan
                    .col-12.col-md-6.col-lg-4.col-xl-3
                        .card.h-100.shadow-sm.border-0.project-card
                            //- HÌNH ẢNH
                            .position-relative
                                if item.hinh_anh && item.hinh_anh.length > 0
                                    img.card-img-top(src=item.hinh_anh[0], alt=item.ten_du_an, style="height: 200px; object-fit: cover;")
                                else
                                    img.card-img-top(src="/img/no-image.png", alt="No Image", style="height: 200px; object-fit: cover; background-color: #f8f9fa;")
                                
                                //- Badge Loại hình (Góc trái trên)
                                .position-absolute.top-0.start-0.m-2
                                    if item.loai_hinh == 'BietThu'
                                        span.badge.bg-success Biệt Thự
                                    else if item.loai_hinh == 'NhaPho'
                                        span.badge.bg-primary Nhà Phố
                                    else if item.loai_hinh == 'NoiThat'
                                        span.badge.bg-warning.text-dark Nội Thất
                                    else 
                                        span.badge.bg-secondary #{item.loai_hinh}

                                //- Badge Nổi bật (Góc phải trên)
                                .position-absolute.top-0.end-0.m-2
                                    if item.is_noibat
                                        a.badge.bg-danger.text-decoration-none.shadow-sm(href="javascript:;", data-id=item.id, data_noibat="true", button-change-noibat, title="Click để bỏ nổi bật") 
                                            i.fas.fa-star.me-1
                                            | Hot
                                    else
                                        a.badge.bg-dark.bg-opacity-50.text-decoration-none(href="javascript:;", data-id=item.id, data_noibat="false", button-change-noibat, title="Click để set nổi bật") 
                                            i.far.fa-star

                            //- NỘI DUNG CARD
                            .card-body
                                h5.card-title.fw-bold.text-truncate.mb-3(title=item.ten_du_an)
                                    a.text-decoration-none.text-dark(href=`/admin/duan/edit/${item.id}`) #{item.ten_du_an}
                                
                                //- Thông tin icon
                                .row.g-2.small.text-muted
                                    .col-12
                                        i.fas.fa-map-marker-alt.me-2.text-danger(width="16")
                                        | #{item.dia_diem}
                                    .col-6
                                        i.fas.fa-ruler-combined.me-2.text-success(width="16")
                                        | #{item.dien_tich} m²
                                    .col-6
                                        i.far.fa-calendar-alt.me-2.text-primary(width="16")
                                        | #{item.nam_thuc_hien}
                                
                                //- Trạng thái text
                                .mt-3
                                    if item.trang_thai =='DangThietKe'
                                        span.d-block.w-100.text-center.badge.bg-light.text-info.border.border-info.fw-normal Đang thiết kế
                                    else if item.trang_thai=='HoanThien'
                                        span.d-block.w-100.text-center.badge.bg-light.text-success.border.border-success.fw-normal Hoàn thiện
                                    else if item.trang_thai=='DangThiCong'
                                        span.d-block.w-100.text-center.badge.bg-light.text-warning.border.border-warning.fw-normal Đang thi công

                            //- FOOTER (NÚT THAO TÁC)
                            .card-footer.bg-white.border-top-0.d-flex.justify-content-between.pb-3.pt-0
                                a.btn.btn-outline-primary.btn-sm.flex-grow-1.me-2(href=`/admin/duan/edit/${item.id}`)
                                    i.fas.fa-edit.me-1
                                    | Sửa
                                button.btn.btn-outline-danger.btn-sm(data-id=item.id, button-delete)
                                    i.fas.fa-trash

        else
            //- KHÔNG CÓ DỮ LIỆU
            .text-center.py-5
                .py-5.bg-light.rounded-3
                    i.fas.fa-folder-open.fa-3x.text-muted.mb-3
                    p.text-muted.fs-5 Không tìm thấy dự án nào phù hợp.

        // CODE ĐÃ SỬA LỖI
        .mt-4.d-flex.justify-content-center
            +pagination(pagination) 

    //- Form ẩn dùng cho JS xóa
    form#form-delete-item(method="POST", action="", data-path="/admin/duan/delete")