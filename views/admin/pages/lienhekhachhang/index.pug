extends ../../layout/defaut.pug 
include ../../mixins/search.pug 

block main
  if(role.permissions.includes("lienhe_view"))
    style.
      .kanban-col { flex: 0 0 25%; max-width: 25%; padding: 0 10px; display: flex; flex-direction: column; }
      .col-scroll { overflow-y: auto; max-height: calc(100vh - 250px); padding: 5px; }
      .kanban-card { transition: all 0.2s; border: 1px solid #dee2e6 !important; margin-bottom: 15px; border-radius: 10px; background: #fff; position: relative; }
      .kanban-card:hover { transform: translateY(-3px); box-shadow: 0 .5rem 1rem rgba(0,0,0,0.1)!important; border-color: #0d6efd !important; }
      .avatar-circle { width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; font-weight: bold; border-radius: 50%; font-size: 14px; }
      .note-box { font-size: 0.8rem; background: #fff9db; border-left: 3px solid #fcc419; padding: 5px 8px; margin-top: 10px; border-radius: 4px; }
      
      /* Timeline CSS */
      .timeline-item { position: relative; padding-bottom: 1.5rem; border-left: 2px solid #dee2e6; padding-left: 1.5rem; }
      .timeline-item:last-child { border-left: 2px solid transparent; padding-bottom: 0; }
      .timeline-dot { position: absolute; left: -0.45rem; top: 0; width: 0.8rem; height: 0.8rem; border-radius: 50%; background: #0dcafm; border: 2px solid #fff; }

    .container-fluid.mt-4
      .row.align-items-center.mb-4
        .col-md-6
          h1.text-primary.fw-bold Quản Lý Tiến Độ Tư Vấn
        .col-md-6.d-flex.justify-content-end
          +search(keyword)

      .d-flex.kanban-container.pb-4(style="min-height: calc(100vh - 200px); align-items: flex-start; margin: 0 -10px;")
        
        mixin column(title, colorClass, statusName)
          .kanban-col
            .bg-white.p-3.rounded-3.shadow-sm.border-top.border-4(class=`border-${colorClass}`).mb-3.d-flex.justify-content-between.align-items-center
              div
                i.fas.fa-thumbtack.me-2(class=`text-${colorClass}`)
                span.fw-bold.text-uppercase(class=`text-${colorClass}`) #{title}
              - const count = lienhe.filter(x => x.status == statusName).length
              span.badge.rounded-pill(class=`bg-${colorClass}`) #{count}
            
            .d-flex.flex-column.col-scroll
              each item in lienhe
                if item.status === statusName
                  .card.kanban-card.shadow-sm
                    .card-body.p-3
                      .d-flex.justify-content-between.align-items-start.mb-2
                        .d-flex.align-items-center
                          .avatar-circle.me-2(class=`bg-${colorClass} bg-opacity-10 text-${colorClass}`) 
                            | #{item.fullName ? item.fullName.charAt(0).toUpperCase() : 'N'}
                          div
                            h6.fw-bold.mb-0.text-dark(style="font-size: 0.9rem;") #{item.fullName}
                            small.text-muted(style="font-size: 0.7rem;") #{moment(item.createdAt).format('DD/MM/YYYY HH:mm')}
                        
                        button.btn.btn-link.text-danger.p-0.js-delete-btn(data-id=item.id title="Xóa")
                          i.fas.fa-trash

                      .bg-light.rounded-2.p-2.mb-1
                        p.card-text.small.text-secondary.mb-0 #{item.message || "Không có lời nhắn."}

                      if item.note
                        .note-box
                          i.fas.fa-pen-nib.me-1
                          span #{item.note}

                      .d-flex.justify-content-between.align-items-center.pt-3.mt-2.border-top
                        button.btn.btn-sm.btn-outline-info.js-view-history(
                          type="button"
                          data-name=item.fullName
                          data-history=JSON.stringify(item.history || [])
                        )
                          i.fas.fa-history
                        
                        button.btn.btn-sm.btn-outline-dark.js-btn-update(
                          type="button"
                          data-id=item.id
                          data-status=item.status
                          data-note=(item.note || "")
                        )
                          i.fas.fa-sync-alt.me-1
                          | Cập nhật

        +column('Chờ xử lý', 'danger', 'Chờ xử lý')
        +column('Đã liên hệ', 'warning', 'Đã liên hệ')
        +column('Đang tư vấn', 'primary', 'Đang tư vấn')
        +column('Hoàn thành', 'success', 'Hoàn thành')

    //- MODAL CẬP NHẬT
    div#modalChangeStatus.modal.fade(tabindex="-1" aria-hidden="true")
      .modal-dialog.modal-dialog-centered
        .modal-content
          form(action="/admin/lienhe/change-status" method="POST")
            .modal-header
              h5.modal-title Cập Nhật Trạng Thái
              button.btn-close(type="button" data-bs-dismiss="modal" aria-label="Close")
            .modal-body
              input(type="hidden" name="id" id="inputContactId")
              .mb-3
                label.form-label.fw-bold Trạng thái:
                select.form-select(name="status" id="selectStatus")
                  option(value="Chờ xử lý") Chờ xử lý
                  option(value="Đã liên hệ") Đã liên hệ
                  option(value="Đang tư vấn") Đang tư vấn
                  option(value="Hoàn thành") Hoàn thành
              .mb-3
                label.form-label.fw-bold Ghi chú:
                textarea.form-control(name="note" id="inputNote" rows="3")
            .modal-footer
              button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Đóng
              button.btn.btn-primary(type="submit") Lưu lại

    //- MODAL LỊCH SỬ (Đã thêm đầy đủ nút thoát)
    div#modalHistory.modal.fade(tabindex="-1" aria-hidden="true")
      .modal-dialog.modal-dialog-centered.modal-dialog-scrollable
        .modal-content
          .modal-header.bg-info.text-white
            h5.modal-title Nhật ký tư vấn: #[span#customerNameHeader]
            button.btn-close.btn-close-white(type="button" data-bs-dismiss="modal" aria-label="Close")
          .modal-body
            #historyContent
          .modal-footer
            button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Thoát

    form#form-delete-item(method="POST" action="" data-path="/admin/lienhe/delete")

  else
    .container.mt-5
      .alert.alert-warning.text-center
        h4 Bạn không có quyền xem trang này!