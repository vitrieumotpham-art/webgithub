extends ../../layout/defaut.pug

block main
  if(role.permissions.includes("thongke_view"))
    style.
      :root {
        --pnt-gold: #c5a059;
        --pnt-dark: #1a1a1a;
      }
      .dashboard-container {
        background-color: #f4f7f6;
        min-height: 100vh;
        padding-bottom: 50px;
      }
      .card {
        border: none;
        transition: all 0.3s ease;
        margin-bottom: 20px;
      }
      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.08) !important;
      }
      .icon-shape {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      }
      .text-pnt-gold {
        color: var(--pnt-gold) !important;
      }
      .bg-pnt-dark {
        background-color: var(--pnt-dark) !important;
      }
      .badge-soft-gold {
        background-color: rgba(197, 160, 89, 0.1);
        color: var(--pnt-gold);
        border: 1px solid rgba(197, 160, 89, 0.2);
      }
      canvas {
        max-width: 100% !important;
        height: 300px !important;
      }

    .dashboard-container
      .container-fluid.py-4
        .d-flex.justify-content-between.align-items-center.mb-4
          h2.fw-bold.text-dark #{pageTitle}
          .text-muted.small 2026 © PNT DECOR Admin Panel

        //- Hàng 1: Thẻ thống kê con số
        .row
          .col-xl-3.col-sm-6
            .card.shadow-sm.rounded-3
              .card-body.p-3
                .d-flex.justify-content-between.align-items-center
                  div
                    p.text-xs.mb-0.text-uppercase.text-muted.fw-bold Dự án
                    h3.fw-bold.mb-0 #{statistic.totalProjects}
                  .icon-shape.bg-primary.text-white.rounded-3
                    i.fa-solid.fa-castle.fa-lg

          .col-xl-3.col-sm-6
            .card.shadow-sm.rounded-3
              .card-body.p-3
                .d-flex.justify-content-between.align-items-center
                  div
                    p.text-xs.mb-0.text-uppercase.text-muted.fw-bold Khách tư vấn
                    h3.fw-bold.mb-0 #{statistic.totalLeads}
                  .icon-shape.bg-success.text-white.rounded-3
                    i.fa-solid.fa-user-tie.fa-lg

          .col-xl-3.col-sm-6
            .card.shadow-sm.rounded-3
              .card-body.p-3
                .d-flex.justify-content-between.align-items-center
                  div
                    p.text-xs.mb-0.text-uppercase.text-muted.fw-bold Bài viết
                    h3.fw-bold.mb-0 #{statistic.totalArticles}
                  .icon-shape.bg-info.text-white.rounded-3
                    i.fa-solid.fa-newspaper.fa-lg

          .col-xl-3.col-sm-6
            .card.shadow-sm.rounded-3
              .card-body.p-3
                .d-flex.justify-content-between.align-items-center
                  div
                    p.text-xs.mb-0.text-uppercase.text-muted.fw-bold Tổng giá trị
                    h4.fw-bold.mb-0.text-pnt-gold #{statistic.revenue}
                  .icon-shape.bg-pnt-dark.text-pnt-gold.rounded-3
                    i.fa-solid.fa-hand-holding-dollar.fa-lg

        //- Hàng 2: Biểu đồ
        .row.mt-3
          .col-lg-7
            .card.shadow-sm.p-4
              h5.fw-bold.mb-4 
                i.fa-solid.fa-chart-line.me-2
                | Biểu đồ tăng trưởng doanh thu
              canvas#lineChart
          
          .col-lg-5
            .card.shadow-sm.p-4
              h5.fw-bold.mb-4 
                i.fa-solid.fa-chart-pie.me-2
                | Tỷ lệ loại hình công trình
              canvas#pieChart

        //- Hàng 3: Bảng dự án mới nhất
        .row.mt-3
          .col-12
            .card.shadow-sm.border-0.rounded-3
              .card-header.bg-white.py-3.border-0
                .d-flex.justify-content-between.align-items-center
                  h5.mb-0.fw-bold Dự án mới cập nhật
                  a.btn.btn-sm.btn-outline-primary.rounded-pill(href="/admin/duan") Xem tất cả
              .card-body.p-0
                .table-responsive
                  table.table.align-middle.mb-0
                    thead.table-light
                      tr
                        th.ps-4 Tên dự án
                        th Chủ đầu tư
                        th Loại hình
                        th Chi phí (VNĐ)
                        th.pe-4 Ngày tạo
                    tbody
                      if latestProjects && latestProjects.length > 0
                        each project in latestProjects
                          tr
                            td.ps-4.fw-bold.text-dark #{project.ten_du_an}
                            td #{project.chu_dau_tu}
                            td 
                              span.badge.badge-soft-gold.rounded-pill #{project.loai_hinh}
                            td.text-primary.fw-bold #{project.chi_phi ? project.chi_phi.toLocaleString() : 0}
                            td.pe-4.text-muted #{project.createdAt.toLocaleDateString('vi-VN')}
                      else
                        tr
                          td.text-center(colspan="5") Chưa có dữ liệu dự án.

    script(src="https://cdn.jsdelivr.net/npm/chart.js")
    script.
      // Dữ liệu từ Controller cho biểu đồ tròn
      const pieDataValues = !{JSON.stringify(chartData.pie)};
      
      // 1. Biểu đồ tròn
      const ctxPie = document.getElementById('pieChart').getContext('2d');
      new Chart(ctxPie, {
        type: 'doughnut',
        data: {
          labels: ['Biệt Thự', 'Nhà Phố', 'Nội Thất'],
          datasets: [{
            data: pieDataValues,
            backgroundColor: ['#0d6efd', '#c5a059', '#1a1a1a'],
            hoverOffset: 10,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } }
        }
      });

      // 2. Biểu đồ đường (CẬP NHẬT DỮ LIỆU THẬT)
      const ctxLine = document.getElementById('lineChart').getContext('2d');
      new Chart(ctxLine, {
        type: 'line',
        data: {
          // Lấy tên tháng thật từ DB (Ví dụ: Tháng 1, Tháng 2...)
          labels: !{JSON.stringify(chartData.lineLabels)}, 
          datasets: [{
            label: 'Giá trị dự án (VNĐ)',
            // Lấy doanh thu thật theo tháng từ DB
            data: !{JSON.stringify(chartData.lineData)},
            borderColor: '#c5a059',
            backgroundColor: 'rgba(197, 160, 89, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.parsed.y.toLocaleString('vi-VN') + ' VNĐ';
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value.toLocaleString('vi-VN') + ' đ';
                }
              }
            }
          }
        }
      });